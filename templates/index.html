<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // Datos dinámicos desde Flask
    const tablas = {{ tablas_json | safe }};
    const cargas_dias = {{ cargas_dias_json | safe }};
    const estados = {{ estados_json | safe }};

    // Instancias globales de las gráficas
    let barChart, lineChart, pieChart;

    // Función para obtener colores según el modo
    function getChartColors() {
        const dark = document.body.classList.contains('dark-mode');

        return {
            text: dark ? '#ffffff' : '#000000',
            grid: dark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.1)',
            background: dark ? '#2a2b2f' : '#ffffff'
        };
    }

    // Crear todas las gráficas
    function createCharts() {
        const colors = getChartColors();

        // Gráfica de barras
        barChart = new Chart(document.getElementById('barChart'), {
            type: 'bar',
            data: {
                labels: tablas.labels,
                datasets: [{
                    label: 'Registros',
                    data: tablas.values,
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                plugins: { legend: { labels: { color: colors.text } } },
                scales: {
                    x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                    y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
                }
            }
        });

        // Gráfica de líneas
        lineChart = new Chart(document.getElementById('lineChart'), {
            type: 'line',
            data: {
                labels: cargas_dias.labels,
                datasets: [{
                    label: 'Cargas',
                    data: cargas_dias.values,
                    borderColor: '#198754',
                    tension: 0.3
                }]
            },
            options: {
                plugins: { legend: { labels: { color: colors.text } } },
                scales: {
                    x: { ticks: { color: colors.text }, grid: { color: colors.grid } },
                    y: { ticks: { color: colors.text }, grid: { color: colors.grid } }
                }
            }
        });

        // Gráfica de pastel
        pieChart = new Chart(document.getElementById('pieChart'), {
            type: 'pie',
            data: {
                labels: estados.labels,
                datasets: [{
                    data: estados.values,
                    backgroundColor: ['#0d6efd', '#198754', '#dc3545', '#ffc107', '#6f42c1']
                }]
            },
            options: {
                plugins: { legend: { labels: { color: colors.text } } }
            }
        });
    }

    // Actualizar colores cuando cambia el modo oscuro
    function updateChartsTheme() {
        const colors = getChartColors();

        const charts = [barChart, lineChart, pieChart];

        charts.forEach(chart => {
            if (!chart) return;

            // Actualizar colores de texto y grid
            if (chart.options.scales) {
                Object.values(chart.options.scales).forEach(scale => {
                    scale.ticks.color = colors.text;
                    scale.grid.color = colors.grid;
                });
            }

            // Actualizar leyendas
            if (chart.options.plugins?.legend?.labels) {
                chart.options.plugins.legend.labels.color = colors.text;
            }

            chart.update();
        });
    }

    // Crear gráficas al cargar la página
    createCharts();

    // Detectar cambios del toggle
    document.getElementById('themeToggle').addEventListener('change', () => {
        setTimeout(updateChartsTheme, 150);
    });
</script>
